# IGNORE:TK - This action checks for TK-TODO markers
name: TK-TODO Check Action
description: |
  Checks for TK-TODO markers in your codebase that must be resolved before merge.
  Markers can be suppressed by adding 'IGNORE:TK' (case-insensitive) on the same line.
branding:
  icon: check-circle
  color: green

inputs:
  fail-on-found:
    # IGNORE:TK - documentation
    description: "Whether to fail the action if TK-TODO markers are found (default: true)"
    required: false
    default: "true"
  exclude-patterns:
    description: "Glob patterns to exclude from the check (space-separated, e.g., '*.md docs/*')"
    required: false
    default: ""

outputs:
  found-count:
    # IGNORE:TK - documentation
    description: "Number of TK-TODO markers found"
    value: ${{ steps.check.outputs.found-count }}
  found-markers:
    # IGNORE:TK - documentation
    description: "List of found TK-TODO markers (file:line format)"
    value: ${{ steps.check.outputs.found-markers }}

runs:
  using: "composite"
  steps:
    - name: Check for TK-TODO markers  # IGNORE:TK
      id: check
      shell: bash
      run: |
        # Find all TK-TODO markers (case-insensitive) that don't have IGNORE:TK on the same line  # IGNORE:TK
        # Exit with error if any are found and fail-on-found is true

        echo "Checking for TK-TODO markers..."  # IGNORE:TK

        # Build exclude arguments for grep
        # Use set -f to disable glob expansion so patterns like *.md are passed literally to grep
        EXCLUDE_ARGS=""
        if [ -n "${{ inputs.exclude-patterns }}" ]; then
          set -f  # Disable glob expansion
          for pattern in ${{ inputs.exclude-patterns }}; do
            EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$pattern"
          done
          set +f  # Re-enable glob expansion
          echo "Excluding patterns: ${{ inputs.exclude-patterns }}"
        fi

        # Use git ls-files -z with xargs -0 to handle filenames with spaces
        # grep -i for case-insensitive matching
        # grep -v for excluding lines with IGNORE:TK
        # grep -n for line numbers

        FOUND_TODOS=$(git ls-files -z | xargs -0 grep -i -n $EXCLUDE_ARGS "TK-TODO" 2>/dev/null | grep -i -v "IGNORE:TK" || true)  # IGNORE:TK

        if [ -n "$FOUND_TODOS" ]; then
          # Count the number of markers found
          FOUND_COUNT=$(echo "$FOUND_TODOS" | wc -l | tr -d ' ')
          echo "found-count=$FOUND_COUNT" >> $GITHUB_OUTPUT

          # Save markers to output
          echo "found-markers<<EOF" >> $GITHUB_OUTPUT
          echo "$FOUND_TODOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo ""
          echo "::error::Found $FOUND_COUNT TK-TODO marker(s) that must be resolved before merge"  # IGNORE:TK
          echo ""
          echo "$FOUND_TODOS"
          echo ""
          echo "To suppress a TK-TODO, add 'IGNORE:TK' (case-insensitive) on the same line."  # IGNORE:TK
          echo ""

          if [ "${{ inputs.fail-on-found }}" == "true" ]; then
            exit 1
          fi
        else
          echo "found-count=0" >> $GITHUB_OUTPUT
          echo "found-markers=" >> $GITHUB_OUTPUT
          echo "No unresolved TK-TODO markers found."  # IGNORE:TK
        fi
